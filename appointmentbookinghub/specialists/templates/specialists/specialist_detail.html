{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-base-200 p-10">
    <div class="max-w-6xl mx-auto">
        
        <div class="navbar bg-base-100 shadow-xl rounded-box mb-6">
            <div class="navbar-start">
                <a href="/specialists/" class="btn btn-ghost">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back to Specialists
                </a>
            </div>
            <div class="navbar-center">
                <h1 class="text-xl font-bold">Book Appointment</h1>
            </div>
            <div class="navbar-end">
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost">
                        {{ user.username }}
                        <div class="badge badge-sm badge-outline">{{ user.role }}</div>
                    </div>
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                        <li><a href="{% url 'logout' %}">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1">
                <div class="card bg-base-100 shadow-xl sticky top-6">
                    <div class="card-body">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="avatar placeholder">
                                <div class="bg-primary text-primary-content rounded-full w-20">
                                    <span class="text-2xl font-bold">
                                        {{ specialist.user.username|first|upper }}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <h2 class="card-title text-2xl">{{ specialist.user.username }}</h2>
                                <div class="badge badge-secondary badge-lg">{{ specialist.specialty }}</div>
                            </div>
                        </div>

                        {% if specialist.bio %}
                            <div class="mb-6">
                                <h3 class="font-semibold mb-2">About</h3>
                                <p class="text-sm text-base-content/80">{{ specialist.bio }}</p>
                            </div>
                        {% endif %}

                        <div class="mb-6">
                            <h3 class="font-semibold mb-3">Regular Schedule</h3>
                            {% if availabilities %}
                                <div class="space-y-2">
                                    {% for availability in availabilities %}
                                    <div class="flex justify-between items-center p-2 bg-base-200 rounded">
                                        <span class="font-medium">
                                            {% if availability.weekday == 0 %}Monday
                                            {% elif availability.weekday == 1 %}Tuesday  
                                            {% elif availability.weekday == 2 %}Wednesday
                                            {% elif availability.weekday == 3 %}Thursday
                                            {% elif availability.weekday == 4 %}Friday
                                            {% elif availability.weekday == 5 %}Saturday
                                            {% elif availability.weekday == 6 %}Sunday
                                            {% endif %}
                                        </span>
                                        <span class="text-sm">
                                            {{ availability.start_time|time:"g:i A" }} - {{ availability.end_time|time:"g:i A" }}
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <span>No availability schedule set yet.</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-primary mb-6">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Select Date & Time
                        </h2>

                        <div class="mb-6">
                            <label class="label">
                                <span class="label-text font-semibold">Choose Date</span>
                            </label>
                            <input type="date" 
                                   class="input input-bordered w-full" 
                                   id="date-picker"
                                   min="{{ "now"|date:"Y-m-d" }}"
                                   value="{{ "now"|date:"Y-m-d" }}"
                                   hx-get="/specialists/{{ specialist.id }}/calendar/"
                                   hx-target="#time-slots"
                                   hx-trigger="change"
                                   hx-include="[name='csrfmiddlewaretoken']">
                        </div>

                        <div class="mb-6">
                            <label class="label">
                                <span class="label-text font-semibold">Available Times</span>
                            </label>
                            <div id="time-slots" 
                                 hx-get="/specialists/{{ specialist.id }}/calendar/"
                                 hx-trigger="load"
                                 hx-include="[name='csrfmiddlewaretoken']">
                                <div class="flex justify-center py-8">
                                    <span class="loading loading-spinner loading-lg"></span>
                                </div>
                            </div>
                        </div>

                        <div id="appointment-summary" class="hidden">
                            <div class="alert alert-info mb-6">
                                <div>
                                    <h4 class="font-bold">Appointment Summary</h4>
                                    <p id="summary-text"></p>
                                </div>
                            </div>
                            
                            <div class="card-actions justify-end">
                                <button class="btn btn-primary btn-lg"
                                        id="confirm-booking"
                                        hx-post="/bookings/create/"
                                        hx-target="#booking-result"
                                        hx-include="[name='csrfmiddlewaretoken']">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Confirm Booking
                                </button>
                            </div>
                        </div>

                        <div id="booking-confirmation"></div>
                        <div id="booking-result"></div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<input type="hidden" id="specialist-id" value="{{ specialist.id }}">
<input type="hidden" id="selected-start-time">
<input type="hidden" id="selected-end-time">

<meta name="csrf-token" content="{{ csrf_token }}">
{% csrf_token %}

<script>
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.target.id === 'time-slots') {
        const response = JSON.parse(event.detail.xhr.response);
        const slotsContainer = event.target;
        
        if (response.available_slots && response.available_slots.length > 0) {
            let slotsHtml = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
            
            response.available_slots.forEach(slot => {
                slotsHtml += `
                    <button class="btn btn-outline time-slot-btn" 
                            data-start="${slot.start_time}" 
                            data-end="${slot.end_time}"
                            onclick="selectTimeSlot(this, '${slot.display_time}', '${response.date}')">
                        ${slot.display_time}
                    </button>
                `;
            });
            
            slotsHtml += '</div>';
            slotsContainer.innerHTML = slotsHtml;
        } else {
            slotsContainer.innerHTML = `
                <div class="alert alert-warning">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>No available time slots for this date.</span>
                </div>
            `;
        }
    }
});

function selectTimeSlot(button, displayTime, date) {
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
    });
    
    button.classList.remove('btn-outline');
    button.classList.add('btn-primary');
    
    document.getElementById('selected-start-time').value = button.dataset.start;
    document.getElementById('selected-end-time').value = button.dataset.end;
    
    const summary = document.getElementById('appointment-summary');
    const summaryText = document.getElementById('summary-text');
    summaryText.innerHTML = `
        <strong>Date:</strong> ${new Date(date).toLocaleDateString()}<br>
        <strong>Time:</strong> ${displayTime}<br>
        <strong>Specialist:</strong> {{ specialist.user.username }}
    `;
    summary.classList.remove('hidden');
}

document.getElementById('confirm-booking').addEventListener('click', function() {
    const startTime = document.getElementById('selected-start-time').value;
    const endTime = document.getElementById('selected-end-time').value;
    const specialistId = document.getElementById('specialist-id').value;
    
    this.setAttribute('hx-vals', JSON.stringify({
        'specialist_id': specialistId,
        'start_time': startTime,
        'end_time': endTime
    }));
});
</script>

{% endblock %}